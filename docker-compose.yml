version: '3.8'

# JUGGERNAUT RAIL - License-Based Deployment
# Customer deploys this in their infrastructure

services:
  juggernaut-rail:
    build:
      context: .
      target: production
    container_name: juggernaut-rail
    ports:
      - "${PORT:-8000}:8000"
    environment:
      - PORT=8000
      - API_KEY=${API_KEY:?API_KEY is required}
      - LICENSE_KEY=${LICENSE_KEY:?LICENSE_KEY is required}
      - DATABASE_URL=${DATABASE_URL:-sqlite:///data/juggernaut.db}
      - KEY_MASTER_SECRET=${KEY_MASTER_SECRET:?KEY_MASTER_SECRET is required}
      - KEY_STORAGE_PATH=/data/keys
      - CORS_ORIGINS=${CORS_ORIGINS:-*}
      - DEBUG=false
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
    volumes:
      - juggernaut_data:/data
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s
    restart: unless-stopped
    networks:
      - juggernaut-network
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 1G
    security_opt:
      - no-new-privileges:true

  # PostgreSQL (optional - for production)
  postgres:
    image: postgres:16-alpine
    container_name: juggernaut-postgres
    environment:
      - POSTGRES_USER=${POSTGRES_USER:-juggernaut}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:?POSTGRES_PASSWORD is required}
      - POSTGRES_DB=${POSTGRES_DB:-juggernaut}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-juggernaut}"]
      interval: 30s
      timeout: 10s
      retries: 5
    restart: unless-stopped
    networks:
      - juggernaut-network
    profiles:
      - with-postgres

networks:
  juggernaut-network:
    driver: bridge

volumes:
  juggernaut_data:
  postgres_data:
